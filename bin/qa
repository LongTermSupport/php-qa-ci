#!/usr/bin/env bash
###################################################################
#
# PHP QA Pipeline
#
# Usage:
#
# Standard:
# ./bin/qa
#
# Run all PHPUnit tests:
# phpUnitQuickTests=0 ./bin/qa

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
cd $DIR;
set -e
set -u
set -o pipefail
standardIFS="$IFS"
IFS=$'\n\t'
echo "
===========================================
$(hostname) $0 $@
===========================================
"

readonly runMode_all="all-tests"
readonly runMode_quick="quick-tests"
readonly scanScope_platform="platform-scan"
readonly scanScope_path="path-scan"


function usage {
    echo "Usage:"
    echo "bin/qa [quick-tests|all-tests] [subfolder/to/scan]"
    echo ""
    exit 1
}
phpBinPath=$(which php)
mode=${1:-$runMode_all};
if [[ $mode != $runMode_all && $mode != $runMode_quick ]]
then
    usage
fi

scanPath=${2:-""};

#### FUNCTIONS #################################################
source ./../includes/functions.inc.bash


#### CONFIG ##################################################

# If a CI variable is set, we use that, otherwise default to false.
# Travis-CI sets a CI variable. You can eaisly set this in any other CI system
# The value should the the string 'true' if this is CI
CI=${CI:-'false'}

# project root directory
if [[ -d $DIR/../vendor ]]
then
    projectRoot="$(readlink -f $DIR/../)"
else
    projectRoot="$(readlink -f $DIR/../../../../)"
fi

# the path in the project to check for config
projectConfigPath="$projectRoot/qaConfig/"

# Which platform is the code to be tested
platform="$(detectPlatform)"
echo "$platform platform detected"

runTool setConfig

#### PROCESS #################################################

hasBeenRestarted="false"

# override configs with project configs
overridePath="$projectConfigPath/qaConfig.inc.bash"

if [[ -f "$overridePath" ]]
then
    echo "Found override config at $overridePath"
    source $overridePath
fi

cd "$projectRoot";

runTool prepareDirectories

if [[ -f $projectConfigPath/hookPre.bash ]]
then
    echo "

Running Pre Hook $projectConfigPath/hookPre.bash
------------------------------------------------
"
    source $projectConfigPath/hookPre.bash
fi


echo "

Checking for Composer Issues
----------------------------
"
set +e
phpNoXdebug -f $(which composer) -- diagnose
set +x
set -e

echo "

Refreshing Composer Autoloader
-----------------------------
"
phpNoXdebug -f $(which composer) -- dump-autoload
set +x

echo "
Setting Strict Types If It's Missing
-------------------------------------
"

runTool phpStrictTypes

echo "

Running PHP Lint
----------------
"
runTool phpLint

echo "

Running PHPStan
---------------------
"
if [[ $mode = "quick-tests" ]]
then
    echo "Skipping PHPstan because quick-tests was specified"
else
    runTool phpstan
fi

echo "

Running PHPUnit Tests
---------------------
"
if [[ $mode = "quick-tests" ]]
then
    echo "Skipping PHP Unit because quick-tests was specified"
else
    runTool phpunit
fi

echo "

Running PHP Mess Detector
-------------------------
"
#runTool messDetector
echo "

Running Markdown Links Checker
------------------------------
"
runTool markdownLinks

echo "

Checking if Uncommitted Changes
------------------------------
"
checkForUncommittedChanges

echo "

Running Beautifier and Fixer on src and tests
---------------------------------------------
"
runTool beautifierFixer

echo "

Running Code Sniffer on src and tests
-------------------------------------
"

runTool codeSniffer

echo '


###############################
#                             #
#      ALL TESTS PASSING      #
#                             #
#            _                #
#           /(|               #
#          (  :               #
#         __\  \  _____       #
#       (____)  `|            #
#      (____)|   |            #
#       (____).__|            #
#        (___)__.|_____       #
#                             #
#                             #
###############################


'

echo "
Statistics:
"
phpNoXdebug -f bin/phploc "$srcDir" "$testsDir"
set +x

if [[ -f $projectConfigPath/hookPost.bash ]]
then
    echo "

Running Post Hook $projectConfigPath/hookPost.bash
------------------------------------------------
"
    source $projectConfigPath/hookPost.bash
fi

if [[ "false" != "$hasBeenRestarted" ]]
then
    echo "

####################################################################

WARNING - RAN WITH RETRIES

As you have restarted steps in this run,
you should run the whole process again to be sure everything is fine

####################################################################
"
fi

echo "
===========================================
$(hostname) $0 $@ COMPLETED
===========================================
"
